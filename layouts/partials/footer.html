{{- $enableFooterSwitches := .Store.Get "enableFooterSwitches" | default false -}}
{{- $displayThemeToggle := site.Params.theme.displayToggle | default true -}}
{{- $footerSwitchesVisible := and $enableFooterSwitches (or hugo.IsMultilingual $displayThemeToggle) -}}
{{- $copyrightSectionVisible := or (.Site.Params.footer.displayPoweredBy | default true)
.Site.Params.footer.displayCopyright -}}

{{- $copyright := (T "copyright") | default "Â© 2024 Hextra." -}}
{{- $poweredBy := (T "poweredBy") | default "Powered by Hextra" -}}

<footer
    class="hextra-footer hx:bg-gray-100 hx:pb-[env(safe-area-inset-bottom)] hx:dark:bg-neutral-900 hx:print:bg-transparent">
    {{- /* Top Section: Theme Toggles (if enabled) */ -}}
    {{- if $footerSwitchesVisible -}}
    <div class="hx:mx-auto hx:flex hx:gap-2 hx:py-2 hx:px-4 hextra-max-footer-width">
        {{- partial "language-switch.html" (dict "context" .) -}}
        {{- with $displayThemeToggle }}{{ partial "theme-toggle.html" }}{{ end -}}
    </div>
    {{- if or hugo.IsMultilingual $displayThemeToggle -}}
    <hr class="hx:border-gray-200 hx:dark:border-neutral-800" />
    {{- end -}}
    {{- end -}}

    {{- /* Main Footer Content: Links + Copyright */ -}}
    <div
        class="hextra-max-footer-width hx:mx-auto hx:py-8 hx:px-4 hx:pl-[max(env(safe-area-inset-left),1.5rem)] hx:pr-[max(env(safe-area-inset-right),1.5rem)]">

        {{- /* 1. Custom Links (Navigation) */ -}}
        <div class="hx:flex hx:justify-center hx:mb-6">
            {{- partial "custom/footer.html" (dict "context" . "switchesVisible" $footerSwitchesVisible
            "copyrightVisible" $copyrightSectionVisible) -}}
        </div>

        {{- /* 2. Elegant Separator */ -}}
        <div class="hx:border-t hx:border-gray-200 hx:dark:border-neutral-800 hx:w-full hx:mb-6"></div>

        {{- /* 3. Copyright Section */ -}}
        {{- if $copyrightSectionVisible -}}
        <div class="hx:flex hx:flex-col hx:items-center hx:text-center hx:text-gray-500 hx:dark:text-gray-400">
            {{- if (.Site.Params.footer.displayPoweredBy | default true) }}
            <div class="hx:font-medium hx:text-sm hx:mb-1">{{ template "theme-credit" $poweredBy }}</div>
            {{- end -}}
            {{- if .Site.Params.footer.displayCopyright }}
            <div class="hx:text-sm hx:opacity-80">{{ $copyright | markdownify }}</div>
            {{- end -}}
        </div>
        {{- end -}}

    </div>
</footer>

{{- define "theme-credit" -}}
<a class="hx:flex hx:text-sm hx:items-center hx:gap-1 hx:text-current" target="_blank" rel="noopener noreferrer"
    title="Hextra GitHub Homepage" href="https://github.com/imfing/hextra">
    <span>
        {{- . | markdownify -}}
        {{- if strings.Contains . "Hextra" -}}
        {{- partial "utils/icon.html" (dict "name" "hextra" "attributes" `height=1em class="hx:inline-block hx:ltr:ml-1
        hx:rtl:mr-1 hx:align-[-2.5px]"`) -}}
        {{- end -}}
    </span>
</a>
{{- end -}}

<!-- SVG Progress Scroll Button -->
<div class="progress-wrap">
    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98" />
    </svg>
</div>

<script>
    (function () {
        var progressPath = document.querySelector('.progress-wrap path');
        var pathLength = progressPath.getTotalLength();

        // Set up CSS transition
        progressPath.style.transition = progressPath.style.WebkitTransition = 'none';
        progressPath.style.strokeDasharray = pathLength + ' ' + pathLength;
        progressPath.style.strokeDashoffset = pathLength;
        progressPath.getBoundingClientRect();
        progressPath.style.transition = progressPath.style.WebkitTransition = 'stroke-dashoffset 10ms linear';

        function updateProgress() {
            // Calculate scroll percentage
            var scroll = window.scrollY || document.documentElement.scrollTop;
            var height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            var progress = pathLength - (scroll * pathLength / height);
            progressPath.style.strokeDashoffset = progress;

            // Toggle visibility
            var scrollWrap = document.querySelector('.progress-wrap');
            if (scroll > 50) {
                scrollWrap.classList.add('active-progress');
            } else {
                scrollWrap.classList.remove('active-progress');
            }
        }

        // Initial update
        updateProgress();

        // Optimized scroll listener
        var ticking = false;
        window.addEventListener('scroll', function () {
            if (!ticking) {
                window.requestAnimationFrame(function () {
                    updateProgress();
                    ticking = false;
                });
                ticking = true;
            }
        }, { passive: true });

        // Smooth scroll to top
        document.querySelector('.progress-wrap').addEventListener('click', function (event) {
            event.preventDefault();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            return false;
        });
    })();
</script>